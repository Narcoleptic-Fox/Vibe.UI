@using Vibe.UI.Docs.Models
@inject IJSRuntime JS

@*
    LivePreview - Interactive component preview with code view and prop tweaker
    Combines preview, code, and property controls in a tabbed interface
*@

<div class="live-preview rounded-xl border border-zinc-200 dark:border-zinc-800 overflow-hidden bg-white dark:bg-zinc-900">
    <!-- Header Tabs -->
    <div class="flex items-center justify-between border-b border-zinc-200 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-800/50">
        <!-- Tab Buttons -->
        <div class="flex">
            <button class="px-4 py-2.5 text-sm font-medium transition-colors relative @(activeTab == "preview" ? "text-zinc-900 dark:text-zinc-100" : "text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300")"
                    @onclick="SetPreviewTab">
                Preview
                @if (activeTab == "preview")
                {
                    <span class="absolute bottom-0 left-0 right-0 h-0.5 bg-brand-teal"></span>
                }
            </button>
            <button class="px-4 py-2.5 text-sm font-medium transition-colors relative @(activeTab == "code" ? "text-zinc-900 dark:text-zinc-100" : "text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300")"
                    @onclick="async () => await SetCodeTab()">
                Code
                @if (activeTab == "code")
                {
                    <span class="absolute bottom-0 left-0 right-0 h-0.5 bg-brand-teal"></span>
                }
            </button>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center gap-1 px-2">
            <!-- Theme Toggle -->
            <button class="p-2 rounded-md hover:bg-zinc-200 dark:hover:bg-zinc-700 transition-colors"
                    @onclick="TogglePreviewTheme"
                    title="Toggle preview theme">
                @if (previewDark)
                {
                    <svg class="w-4 h-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                }
                else
                {
                    <svg class="w-4 h-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                }
            </button>

            <!-- Props Toggle -->
            @if (Props.Any())
            {
                <button class="p-2 rounded-md transition-colors @(showProps ? "bg-brand-teal/10 text-brand-teal" : "hover:bg-zinc-200 dark:hover:bg-zinc-700 text-zinc-500")"
                        @onclick="() => showProps = !showProps"
                        title="Toggle properties panel">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                    </svg>
                </button>
            }

            <!-- Copy Button -->
            <CopyButton Text="@Code" Variant="CopyButton.CopyButtonVariant.Ghost" />
        </div>
    </div>

    <!-- Content -->
    <div class="flex">
        <!-- Main Content Area -->
        <div class="flex-1 min-w-0">
            @if (activeTab == "preview")
            {
                <!-- Preview Panel -->
                <div class="preview-panel p-6 min-h-[200px] flex items-center justify-center @(previewDark ? "dark bg-zinc-900" : "bg-white")">
                    <div class="preview-checkerboard @(previewDark ? "dark" : "")">
                        @PreviewContent
                    </div>
                </div>
            }
            else
            {
                <!-- Code Panel -->
                <div class="code-panel">
                    @if (!string.IsNullOrEmpty(highlightedCode))
                    {
                        @((MarkupString)highlightedCode)
                    }
                    else
                    {
                        <pre class="p-4 text-sm font-mono text-zinc-700 dark:text-zinc-300 overflow-x-auto"><code>@Code</code></pre>
                    }
                </div>
            }
        </div>

        <!-- Props Panel (slide-in) -->
        @if (showProps && Props.Any())
        {
            <div class="w-72 border-l border-zinc-200 dark:border-zinc-800 props-slide-in">
                <PropTweaker Props="Props"
                             ShowCodePreview="false"
                             OnPropChanged="HandlePropChanged"
                             OnReset="HandlePropsReset" />
            </div>
        }
    </div>
</div>

<style>
    .preview-panel {
        background-image: linear-gradient(45deg, #f5f5f5 25%, transparent 25%),
                          linear-gradient(-45deg, #f5f5f5 25%, transparent 25%),
                          linear-gradient(45deg, transparent 75%, #f5f5f5 75%),
                          linear-gradient(-45deg, transparent 75%, #f5f5f5 75%);
        background-size: 20px 20px;
        background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    }

    .preview-panel.dark {
        background-image: linear-gradient(45deg, #27272a 25%, transparent 25%),
                          linear-gradient(-45deg, #27272a 25%, transparent 25%),
                          linear-gradient(45deg, transparent 75%, #27272a 75%),
                          linear-gradient(-45deg, transparent 75%, #27272a 75%);
    }

    .code-panel :deep(pre) {
        margin: 0;
        padding: 1rem;
        overflow-x: auto;
        font-size: 0.875rem;
        line-height: 1.5;
    }

    .code-panel :deep(pre code) {
        font-family: 'JetBrains Mono', monospace;
    }

    .props-slide-in {
        animation: slideInRight 0.2s ease-out;
    }

    @@keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
</style>

@code {
    /// <summary>
    /// The content to render in the preview panel.
    /// </summary>
    [Parameter]
    public RenderFragment? PreviewContent { get; set; }

    /// <summary>
    /// The code to display in the code tab.
    /// </summary>
    [Parameter]
    public string Code { get; set; } = string.Empty;

    /// <summary>
    /// The language for syntax highlighting (default: razor).
    /// </summary>
    [Parameter]
    public string Language { get; set; } = "razor";

    /// <summary>
    /// Optional list of props for the PropTweaker.
    /// </summary>
    [Parameter]
    public List<PropDefinition> Props { get; set; } = new();

    /// <summary>
    /// Callback when props are changed.
    /// </summary>
    [Parameter]
    public EventCallback<PropDefinition> OnPropChanged { get; set; }

    /// <summary>
    /// Callback when props are reset.
    /// </summary>
    [Parameter]
    public EventCallback OnPropsReset { get; set; }

    private string activeTab = "preview";
    private bool previewDark = false;
    private bool showProps = false;
    private string? highlightedCode;
    private string? previousCode;
    private bool initialized = false;

    private void SetPreviewTab() => activeTab = "preview";

    private async Task SetCodeTab()
    {
        activeTab = "code";
        if (string.IsNullOrEmpty(highlightedCode) && !string.IsNullOrEmpty(Code))
        {
            await HighlightCode();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Detect page theme on initialization
            try
            {
                previewDark = await JS.InvokeAsync<bool>("eval", "document.documentElement.classList.contains('dark')");
                initialized = true;
                StateHasChanged();
            }
            catch
            {
                // Fallback to light
                previewDark = false;
            }
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Only re-highlight if code changed
        if (Code != previousCode && !string.IsNullOrEmpty(Code))
        {
            previousCode = Code;
            highlightedCode = null; // Reset to force re-highlight
            if (initialized || activeTab == "code")
            {
                await HighlightCode();
            }
        }
    }

    private async Task HighlightCode()
    {
        if (string.IsNullOrEmpty(Code)) return;

        try
        {
            // Use page theme for code highlighting (not preview theme)
            var isDark = await JS.InvokeAsync<bool>("eval", "document.documentElement.classList.contains('dark')");
            var theme = isDark ? "dark" : "light";
            highlightedCode = await JS.InvokeAsync<string>("highlightCode", Code, Language, theme);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            // Fallback to plain code display
            Console.WriteLine($"[LivePreview] Highlight error: {ex.Message}");
            highlightedCode = null;
        }
    }

    private async Task TogglePreviewTheme()
    {
        previewDark = !previewDark;
        await HighlightCode();
    }

    private async Task HandlePropChanged(PropDefinition prop)
    {
        await OnPropChanged.InvokeAsync(prop);
    }

    private async Task HandlePropsReset()
    {
        await OnPropsReset.InvokeAsync();
    }
}
