@using Vibe.UI.Docs.Models
@inject IJSRuntime JS

@*
    LivePreview - Interactive component preview with code view and prop tweaker
    Combines preview, code, and property controls in a tabbed interface
*@

<div class="live-preview vibe-rounded-xl vibe-border vibe-border-zinc-200 dark:vibe-border-zinc-800 vibe-overflow-hidden vibe-bg-white dark:vibe-bg-zinc-900">
    <!-- Header Tabs -->
    <div class="vibe-flex vibe-items-center vibe-justify-between vibe-border-b vibe-border-zinc-200 dark:vibe-border-zinc-800 vibe-bg-zinc-50 dark:vibe-bg-zinc-800/50">
        <!-- Tab Buttons -->
        <div class="vibe-flex" role="tablist" aria-label="Live preview tabs">
            <button class="vibe-px-4 vibe-py-2.5 vibe-text-sm vibe-font-medium vibe-transition-colors vibe-relative @(activeTab == "preview" ? "active vibe-text-zinc-900 dark:vibe-text-zinc-100" : "vibe-text-zinc-500 hover:vibe-text-zinc-700 dark:hover:vibe-text-zinc-300")"
                    type="button"
                    role="tab"
                    data-tab="preview"
                    data-state="@(activeTab == "preview" ? "active" : "inactive")"
                    aria-selected="@(activeTab == "preview" ? "true" : "false")"
                    aria-controls="live-preview-panel"
                    @onclick="SetPreviewTab">
                Preview
                @if (activeTab == "preview")
                {
                    <span class="vibe-absolute vibe-bottom-0 vibe-left-0 vibe-right-0 vibe-h-0.5 vibe-bg-brand-teal"></span>
                }
            </button>
            <button class="vibe-px-4 vibe-py-2.5 vibe-text-sm vibe-font-medium vibe-transition-colors vibe-relative @(activeTab == "code" ? "active vibe-text-zinc-900 dark:vibe-text-zinc-100" : "vibe-text-zinc-500 hover:vibe-text-zinc-700 dark:hover:vibe-text-zinc-300")"
                    type="button"
                    role="tab"
                    data-tab="code"
                    data-state="@(activeTab == "code" ? "active" : "inactive")"
                    aria-selected="@(activeTab == "code" ? "true" : "false")"
                    aria-controls="live-code-panel"
                    @onclick="SetCodeTab">
                Code
                @if (activeTab == "code")
                {
                    <span class="vibe-absolute vibe-bottom-0 vibe-left-0 vibe-right-0 vibe-h-0.5 vibe-bg-brand-teal"></span>
                }
            </button>
        </div>

        <!-- Action Buttons -->
        <div class="vibe-flex vibe-items-center vibe-gap-1 vibe-px-2">
            <!-- Theme Toggle -->
            <button class="vibe-p-2 vibe-rounded-md hover:vibe-bg-zinc-200 dark:hover:vibe-bg-zinc-700 vibe-transition-colors"
                    @onclick="TogglePreviewTheme"
                    title="Toggle preview theme">
                @if (previewDark)
                {
                    <svg class="vibe-w-4 vibe-h-4 vibe-text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                }
                else
                {
                    <svg class="vibe-w-4 vibe-h-4 vibe-text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                }
            </button>

            <!-- Props Toggle -->
            @if (Props.Any())
            {
                <button class="vibe-p-2 vibe-rounded-md vibe-transition-colors @(showProps ? "vibe-bg-brand-teal/10 vibe-text-brand-teal" : "hover:vibe-bg-zinc-200 dark:hover:vibe-bg-zinc-700 vibe-text-zinc-500")"
                        @onclick="() => showProps = !showProps"
                        title="Toggle properties panel">
                    <svg class="vibe-w-4 vibe-h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                    </svg>
                </button>
            }

            <!-- Copy Button -->
            <CopyButton Text="@Code" Variant="CopyButton.CopyButtonVariant.Ghost" />
        </div>
    </div>

    <!-- Content -->
    <div class="vibe-flex">
        <!-- Main Content Area -->
        <div class="vibe-flex-1 vibe-min-w-0">
            @if (activeTab == "preview")
            {
                <!-- Preview Panel -->
                <div id="live-preview-panel"
                     class="preview-panel preview-content vibe-p-6 vibe-min-h-[200px] vibe-flex vibe-items-center vibe-justify-center @(previewDark ? "vibe-bg-zinc-900" : "vibe-bg-white dark:vibe-bg-zinc-900")"
                     role="tabpanel"
                     data-panel="preview">
                    @(PreviewContent ?? ChildContent)
                </div>
            }
            else
            {
                <!-- Code Panel -->
                <div id="live-code-panel"
                     class="code-panel vibe-min-h-[100px] vibe-overflow-x-auto"
                     role="tabpanel"
                     data-panel="code">
                    <CodeBlock Code="@Code" Language="@Language" ShowLineNumbers="false" />
                </div>
            }
        </div>

        <!-- Props Panel (slide-in) -->
        @if (showProps && Props.Any())
        {
            <div class="vibe-w-72 vibe-border-l vibe-border-zinc-200 dark:vibe-border-zinc-800 props-slide-in">
                <PropTweaker Props="Props"
                             ShowCodePreview="false"
                             OnPropChanged="HandlePropChanged"
                             OnReset="HandlePropsReset" />
            </div>
        }
    </div>
</div>

<style>
    .preview-panel {
        background-image: linear-gradient(45deg, #f5f5f5 25%, transparent 25%),
                          linear-gradient(-45deg, #f5f5f5 25%, transparent 25%),
                          linear-gradient(45deg, transparent 75%, #f5f5f5 75%),
                          linear-gradient(-45deg, transparent 75%, #f5f5f5 75%);
        background-size: 20px 20px;
        background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    }

    .preview-panel.dark {
        background-image: linear-gradient(45deg, #27272a 25%, transparent 25%),
                          linear-gradient(-45deg, #27272a 25%, transparent 25%),
                          linear-gradient(45deg, transparent 75%, #27272a 75%),
                          linear-gradient(-45deg, transparent 75%, #27272a 75%);
    }

    .code-panel :deep(pre) {
        margin: 0;
        padding: 1rem;
        overflow-x: auto;
        font-size: 0.875rem;
        line-height: 1.5;
    }

    .code-panel :deep(pre code) {
        font-family: 'JetBrains Mono', monospace;
    }

    .props-slide-in {
        animation: slideInRight 0.2s ease-out;
    }

    @@keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
</style>

@code {
    /// <summary>
    /// Child content for the preview panel (standard Blazor pattern).
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// The content to render in the preview panel.
    /// </summary>
    [Parameter]
    public RenderFragment? PreviewContent { get; set; }

    /// <summary>
    /// The code to display in the code tab.
    /// </summary>
    [Parameter]
    public string Code { get; set; } = string.Empty;

    /// <summary>
    /// The language for syntax highlighting (default: html).
    /// </summary>
    [Parameter]
    public string Language { get; set; } = "html";

    /// <summary>
    /// Optional list of props for the PropTweaker.
    /// </summary>
    [Parameter]
    public List<PropDefinition> Props { get; set; } = new();

    /// <summary>
    /// Callback when props are changed.
    /// </summary>
    [Parameter]
    public EventCallback<PropDefinition> OnPropChanged { get; set; }

    /// <summary>
    /// Callback when props are reset.
    /// </summary>
    [Parameter]
    public EventCallback OnPropsReset { get; set; }

    private string activeTab = "preview";
    private bool previewDark = false;
    private bool showProps = false;

    private void SetPreviewTab() => activeTab = "preview";

    private void SetCodeTab() => activeTab = "code";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Detect page theme on initialization
            try
            {
                previewDark = await JS.InvokeAsync<bool>("eval", "document.documentElement.classList.contains('dark')");
                StateHasChanged();
            }
            catch
            {
                // Fallback to light
                previewDark = false;
            }
        }
    }

    private void TogglePreviewTheme()
    {
        previewDark = !previewDark;
    }

    private async Task HandlePropChanged(PropDefinition prop)
    {
        await OnPropChanged.InvokeAsync(prop);
    }

    private async Task HandlePropsReset()
    {
        await OnPropsReset.InvokeAsync();
    }
}
