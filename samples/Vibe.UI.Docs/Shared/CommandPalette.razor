@inject NavigationManager Navigation

@*
    CommandPalette - Vercel-style Ctrl+K search modal
    Features:
    - Full-screen overlay with backdrop blur
    - Fuzzy search across all components
    - Keyboard navigation (up/down/enter/esc)
    - Quick actions (theme toggle, GitHub)
    - Smooth animations
*@

@if (IsOpen)
{
    <!-- Overlay -->
    <div class="vibe-fixed vibe-inset-0 vibe-z-50 vibe-overlay-enter" @onclick="Close">
        <!-- Backdrop -->
        <div class="vibe-absolute vibe-inset-0 vibe-bg-black/50 vibe-backdrop-blur-sm"></div>

        <!-- Modal -->
        <div class="vibe-relative vibe-flex vibe-items-start vibe-justify-center vibe-pt-[15vh]">
            <div class="vibe-w-full vibe-max-w-xl vibe-mx-4 vibe-modal-enter" @onclick:stopPropagation>
                <div class="vibe-bg-white dark:vibe-bg-zinc-900 vibe-rounded-xl vibe-shadow-2xl vibe-border vibe-border-zinc-200 dark:vibe-border-zinc-800 vibe-overflow-hidden">
                    <!-- Search Header -->
                    <div class="vibe-flex vibe-items-center vibe-gap-3 vibe-px-4 vibe-py-3 vibe-border-b vibe-border-zinc-200 dark:vibe-border-zinc-800">
                        <!-- Search Icon -->
                        <svg class="vibe-w-5 vibe-h-5 vibe-text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>

                        <!-- Search Input -->
                        <input @ref="_searchInput"
                               type="text"
                               placeholder="Search components..."
                               class="vibe-flex-1 vibe-bg-transparent vibe-border-none vibe-outline-none vibe-text-base vibe-text-zinc-900 dark:vibe-text-zinc-100 placeholder:vibe-text-zinc-400"
                               @bind="SearchQuery"
                               @bind:event="oninput"
                               @onkeydown="HandleKeyDown" />

                        <!-- ESC hint -->
                        <Kbd Size="Kbd.KbdSize.Small">ESC</Kbd>
                    </div>

                    <!-- Results -->
                    <div class="vibe-max-h-[400px] vibe-overflow-y-auto">
                        @if (string.IsNullOrWhiteSpace(SearchQuery))
                        {
                            <!-- Quick Actions (when no search query) -->
                            <div class="vibe-p-2">
                                <div class="vibe-px-2 vibe-py-1.5 vibe-text-xs vibe-font-medium vibe-text-zinc-400 vibe-uppercase vibe-tracking-wider">
                                    Quick Actions
                                </div>
                                <button class="vibe-w-full vibe-flex vibe-items-center vibe-gap-3 vibe-px-3 vibe-py-2 vibe-rounded-lg hover:vibe-bg-zinc-100 dark:hover:vibe-bg-zinc-800 vibe-transition-colors vibe-text-left"
                                        @onclick="ToggleTheme">
                                    <svg class="vibe-w-4 vibe-h-4 vibe-text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                                    </svg>
                                    <span class="vibe-text-sm vibe-text-zinc-700 dark:vibe-text-zinc-300">Toggle theme</span>
                                    <span class="vibe-ml-auto vibe-flex vibe-gap-1">
                                        <Kbd Size="Kbd.KbdSize.Small">Ctrl</Kbd>
                                        <Kbd Size="Kbd.KbdSize.Small">T</Kbd>
                                    </span>
                                </button>
                                <a href="https://github.com/AcademyKit/Vibe.UI" target="_blank"
                                   class="vibe-w-full vibe-flex vibe-items-center vibe-gap-3 vibe-px-3 vibe-py-2 vibe-rounded-lg hover:vibe-bg-zinc-100 dark:hover:vibe-bg-zinc-800 vibe-transition-colors">
                                    <svg class="vibe-w-4 vibe-h-4 vibe-text-zinc-500" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                                    </svg>
                                    <span class="vibe-text-sm vibe-text-zinc-700 dark:vibe-text-zinc-300">View on GitHub</span>
                                    <svg class="vibe-w-3 vibe-h-3 vibe-text-zinc-400 vibe-ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                    </svg>
                                </a>
                            </div>

                            <!-- Popular Components -->
                            <div class="vibe-p-2 vibe-border-t vibe-border-zinc-100 dark:vibe-border-zinc-800">
                                <div class="vibe-px-2 vibe-py-1.5 vibe-text-xs vibe-font-medium vibe-text-zinc-400 vibe-uppercase vibe-tracking-wider">
                                    Popular Components
                                </div>
                                @foreach (var component in PopularComponents)
                                {
                                    <button class="vibe-w-full vibe-flex vibe-items-center vibe-gap-3 vibe-px-3 vibe-py-2 vibe-rounded-lg hover:vibe-bg-zinc-100 dark:hover:vibe-bg-zinc-800 vibe-transition-colors vibe-text-left"
                                            @onclick="() => NavigateToComponent(component)">
                                        <div class="vibe-w-8 vibe-h-8 vibe-rounded-md vibe-bg-gradient-to-br vibe-from-brand-teal/10 vibe-to-brand-lilac/10 vibe-flex vibe-items-center vibe-justify-center">
                                            <span class="vibe-text-xs vibe-font-semibold vibe-text-brand-teal">@component.Name[0]</span>
                                        </div>
                                        <div class="vibe-flex-1 vibe-min-w-0">
                                            <div class="vibe-text-sm vibe-font-medium vibe-text-zinc-900 dark:vibe-text-zinc-100">@component.Name</div>
                                            <div class="vibe-text-xs vibe-text-zinc-500 vibe-truncate">@component.Description</div>
                                        </div>
                                        <span class="vibe-text-xs vibe-text-zinc-400">@component.Category</span>
                                    </button>
                                }
                            </div>
                        }
                        else if (FilteredComponents.Any())
                        {
                            <!-- Search Results -->
                            <div class="vibe-p-2">
                                <div class="vibe-px-2 vibe-py-1.5 vibe-text-xs vibe-font-medium vibe-text-zinc-400 vibe-uppercase vibe-tracking-wider">
                                    Components (@FilteredComponents.Count)
                                </div>
                                @for (int i = 0; i < FilteredComponents.Count; i++)
                                {
                                    var component = FilteredComponents[i];
                                    var index = i;
                                    var isSelected = index == _selectedIndex;

                                    <button class="vibe-w-full vibe-flex vibe-items-center vibe-gap-3 vibe-px-3 vibe-py-2 vibe-rounded-lg vibe-transition-colors vibe-text-left @(isSelected ? "vibe-bg-brand-teal/10 dark:vibe-bg-brand-teal/20" : "hover:vibe-bg-zinc-100 dark:hover:vibe-bg-zinc-800")"
                                            @onclick="() => NavigateToComponent(component)"
                                            @onmouseenter="() => _selectedIndex = index">
                                        <div class="vibe-w-8 vibe-h-8 vibe-rounded-md @(isSelected ? "vibe-bg-brand-teal vibe-text-white" : "vibe-bg-gradient-to-br vibe-from-brand-teal/10 vibe-to-brand-lilac/10") vibe-flex vibe-items-center vibe-justify-center vibe-transition-colors">
                                            <span class="vibe-text-xs vibe-font-semibold @(isSelected ? "" : "vibe-text-brand-teal")">@component.Name[0]</span>
                                        </div>
                                        <div class="vibe-flex-1 vibe-min-w-0">
                                            <div class="vibe-text-sm vibe-font-medium vibe-text-zinc-900 dark:vibe-text-zinc-100">
                                                @HighlightMatch(component.Name, SearchQuery)
                                            </div>
                                            <div class="vibe-text-xs vibe-text-zinc-500 vibe-truncate">@component.Description</div>
                                        </div>
                                        <span class="vibe-text-xs @(isSelected ? "vibe-text-brand-teal" : "vibe-text-zinc-400")">@component.Category</span>
                                        @if (isSelected)
                                        {
                                            <svg class="vibe-w-4 vibe-h-4 vibe-text-brand-teal" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                                            </svg>
                                        }
                                    </button>
                                }
                            </div>
                        }
                        else
                        {
                            <!-- No Results -->
                            <div class="vibe-p-8 vibe-text-center">
                                <svg class="vibe-w-12 vibe-h-12 vibe-mx-auto vibe-text-zinc-300 dark:vibe-text-zinc-600 vibe-mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <p class="vibe-text-zinc-500 dark:vibe-text-zinc-400">No components found for "<span class="vibe-font-medium">@SearchQuery</span>"</p>
                                <p class="vibe-text-xs vibe-text-zinc-400 vibe-mt-1">Try a different search term</p>
                            </div>
                        }
                    </div>

                    <!-- Footer -->
                    <div class="vibe-flex vibe-items-center vibe-justify-between vibe-px-4 vibe-py-2 vibe-border-t vibe-border-zinc-200 dark:vibe-border-zinc-800 vibe-bg-zinc-50 dark:vibe-bg-zinc-800/50">
                        <div class="vibe-flex vibe-items-center vibe-gap-4 vibe-text-xs vibe-text-zinc-400">
                            <span class="vibe-flex vibe-items-center vibe-gap-1">
                                <Kbd Size="Kbd.KbdSize.Small">↑</Kbd>
                                <Kbd Size="Kbd.KbdSize.Small">↓</Kbd>
                                Navigate
                            </span>
                            <span class="vibe-flex vibe-items-center vibe-gap-1">
                                <Kbd Size="Kbd.KbdSize.Small">↵</Kbd>
                                Select
                            </span>
                        </div>
                        <span class="vibe-text-xs vibe-text-zinc-400">@AllComponents.Count components</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public bool IsOpen { get; set; }

    [Parameter]
    public EventCallback<bool> IsOpenChanged { get; set; }

    [Parameter]
    public EventCallback OnThemeToggle { get; set; }

    private ElementReference _searchInput;
    private string _searchQuery = string.Empty;
    private int _selectedIndex = 0;

    private string SearchQuery
    {
        get => _searchQuery;
        set
        {
            _searchQuery = value;
            _selectedIndex = 0; // Reset selection when query changes
        }
    }

    // Hardcoded component list - in production, inject ComponentSearchService
    private List<ComponentInfo> AllComponents { get; } = new()
    {
        // Inputs
        new("Button", "Inputs", "Interactive button with multiple variants and states"),
        new("Input", "Inputs", "Text input field with validation support"),
        new("Checkbox", "Inputs", "Checkbox input for boolean values"),
        new("Switch", "Inputs", "Toggle switch for on/off states"),
        new("Select", "Inputs", "Dropdown selection component"),
        new("Slider", "Inputs", "Range slider for numeric input"),
        new("Textarea", "Inputs", "Multi-line text input"),
        new("RadioGroup", "Inputs", "Group of radio button options"),
        new("ColorPicker", "Inputs", "Color selection picker"),

        // Layout
        new("Card", "Layout", "Container for grouping related content"),
        new("Container", "Layout", "Max-width content wrapper"),
        new("Grid", "Layout", "CSS Grid layout system"),
        new("Stack", "Layout", "Flexbox stacking layout"),
        new("Divider", "Layout", "Visual separator between content"),
        new("AspectRatio", "Layout", "Maintain consistent aspect ratios"),

        // Overlay
        new("Dialog", "Overlay", "Modal dialog for focused interactions"),
        new("Drawer", "Overlay", "Side panel overlay"),
        new("Popover", "Overlay", "Floating content panel"),
        new("Tooltip", "Overlay", "Contextual information on hover"),
        new("ContextMenu", "Overlay", "Right-click context menu"),

        // Navigation
        new("Breadcrumb", "Navigation", "Hierarchical navigation path"),
        new("Menu", "Navigation", "Dropdown menu component"),
        new("Pagination", "Navigation", "Page navigation controls"),
        new("Stepper", "Navigation", "Multi-step progress indicator"),
        new("Link", "Navigation", "Navigation link component"),

        // Feedback
        new("Alert", "Feedback", "Contextual feedback messages"),
        new("Toast", "Feedback", "Temporary notification messages"),
        new("Progress", "Feedback", "Progress indicator bar"),
        new("Spinner", "Feedback", "Loading spinner animation"),
        new("Skeleton", "Feedback", "Loading placeholder"),
        new("Badge", "Feedback", "Small count or status indicator"),

        // Data Display
        new("Avatar", "Data Display", "User profile image"),
        new("Table", "Data Display", "Data table component"),
        new("DataTable", "Data Display", "Interactive data grid"),

        // Disclosure
        new("Accordion", "Disclosure", "Collapsible content sections"),
        new("Collapsible", "Disclosure", "Single collapsible panel"),
        new("Carousel", "Disclosure", "Image/content carousel"),

        // DateTime
        new("Calendar", "DateTime", "Date selection calendar"),
        new("DatePicker", "DateTime", "Date input with picker"),
        new("DateRangePicker", "DateTime", "Date range selection"),

        // Advanced
        new("TreeView", "Advanced", "Hierarchical tree structure"),
        new("FileUpload", "Advanced", "File upload with preview"),
        new("RichTextEditor", "Advanced", "WYSIWYG text editor"),

        // Theme
        new("ThemeToggle", "Theme", "Light/dark mode toggle"),
        new("ThemeProvider", "Theme", "Theme context provider"),
    };

    private List<ComponentInfo> PopularComponents => AllComponents
        .Where(c => new[] { "Button", "Card", "Dialog", "Input", "Alert", "Popover" }.Contains(c.Name))
        .Take(6)
        .ToList();

    private List<ComponentInfo> FilteredComponents
    {
        get
        {
            if (string.IsNullOrWhiteSpace(SearchQuery))
                return new List<ComponentInfo>();

            var query = SearchQuery.ToLower();
            return AllComponents
                .Where(c =>
                    c.Name.ToLower().Contains(query) ||
                    c.Description.ToLower().Contains(query) ||
                    c.Category.ToLower().Contains(query))
                .OrderByDescending(c => c.Name.ToLower().StartsWith(query) ? 100 :
                                        c.Name.ToLower().Contains(query) ? 50 : 0)
                .Take(10)
                .ToList();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (IsOpen)
        {
            await Task.Delay(50); // Wait for render
            try
            {
                await _searchInput.FocusAsync();
            }
            catch { }
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        switch (e.Key)
        {
            case "Escape":
                await Close();
                break;

            case "ArrowDown":
                if (FilteredComponents.Any())
                {
                    _selectedIndex = (_selectedIndex + 1) % FilteredComponents.Count;
                }
                break;

            case "ArrowUp":
                if (FilteredComponents.Any())
                {
                    _selectedIndex = _selectedIndex <= 0 ? FilteredComponents.Count - 1 : _selectedIndex - 1;
                }
                break;

            case "Enter":
                if (FilteredComponents.Any() && _selectedIndex < FilteredComponents.Count)
                {
                    NavigateToComponent(FilteredComponents[_selectedIndex]);
                }
                break;
        }
    }

    private async Task Close()
    {
        SearchQuery = string.Empty;
        _selectedIndex = 0;
        await IsOpenChanged.InvokeAsync(false);
    }

    private void NavigateToComponent(ComponentInfo component)
    {
        Navigation.NavigateTo($"components/{component.Name.ToLower()}");
        _ = Close();
    }

    private async Task ToggleTheme()
    {
        await OnThemeToggle.InvokeAsync();
        await Close();
    }

    private MarkupString HighlightMatch(string text, string query)
    {
        if (string.IsNullOrWhiteSpace(query))
            return new MarkupString(text);

        var index = text.IndexOf(query, StringComparison.OrdinalIgnoreCase);
        if (index < 0)
            return new MarkupString(text);

        var before = text[..index];
        var match = text.Substring(index, query.Length);
        var after = text[(index + query.Length)..];

        return new MarkupString($"{before}<span class=\"vibe-text-brand-teal vibe-font-semibold\">{match}</span>{after}");
    }

    private record ComponentInfo(string Name, string Category, string Description);
}
