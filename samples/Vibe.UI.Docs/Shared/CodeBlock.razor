@inject IJSRuntime JS

@*
    CodeBlock - Syntax highlighted code display with Shiki
    Features:
    - VSCode-quality syntax highlighting via Shiki
    - Language label header
    - Copy button with animation
    - Dark/light theme support
*@

<div class="code-block vibe-rounded-lg vibe-border vibe-border-zinc-200 dark:vibe-border-zinc-800 vibe-overflow-hidden vibe-bg-white dark:vibe-bg-zinc-900">
    <!-- Header -->
    <div class="vibe-flex vibe-items-center vibe-justify-between vibe-px-4 vibe-py-2 vibe-bg-zinc-50 dark:vibe-bg-zinc-800/50 vibe-border-b vibe-border-zinc-200 dark:vibe-border-zinc-800">
        <span class="vibe-text-xs vibe-font-medium vibe-text-zinc-500 dark:vibe-text-zinc-400 vibe-uppercase vibe-tracking-wider">@DisplayLanguage</span>
        <CopyButton Text="@Code" Variant="CopyButton.CopyButtonVariant.Ghost" ShowText="false" />
    </div>

    <!-- Code Content -->
    <div class="code-content vibe-overflow-x-auto">
        @if (!string.IsNullOrEmpty(highlightedHtml))
        {
            @((MarkupString)highlightedHtml)
        }
        else
        {
            <!-- Fallback while loading -->
            <pre class="vibe-p-4 vibe-text-sm vibe-leading-relaxed"><code class="vibe-font-mono vibe-text-zinc-700 dark:vibe-text-zinc-300">@Code</code></pre>
        }
    </div>
</div>

<style>
    .code-block .code-content :deep(pre) {
        margin: 0;
        padding: 1rem;
        font-size: 0.875rem;
        line-height: 1.6;
        overflow-x: auto;
    }

    .code-block .code-content :deep(pre code) {
        font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
    }

    /* Shiki theme overrides */
    .code-block .code-content :deep(.shiki) {
        background-color: transparent !important;
    }

    /* Line numbers (optional) */
    .code-block.show-line-numbers .code-content :deep(pre) {
        counter-reset: line;
    }

    .code-block.show-line-numbers .code-content :deep(.line::before) {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        width: 2rem;
        margin-right: 1rem;
        text-align: right;
        color: rgb(161 161 170);
        font-size: 0.75rem;
    }
</style>

@code {
    /// <summary>
    /// The code to display.
    /// </summary>
    [Parameter]
    public string Code { get; set; } = string.Empty;

    /// <summary>
    /// The programming language for syntax highlighting.
    /// </summary>
    [Parameter]
    public string Language { get; set; } = "razor";

    /// <summary>
    /// Whether to show line numbers.
    /// </summary>
    [Parameter]
    public bool ShowLineNumbers { get; set; } = false;

    private string? highlightedHtml;
    private string? previousCode;
    private string? previousLanguage;

    private string DisplayLanguage => Language.ToLower() switch
    {
        "cs" or "csharp" => "C#",
        "js" or "javascript" => "JavaScript",
        "ts" or "typescript" => "TypeScript",
        "html" or "razor" => Language.ToUpper(),
        "css" => "CSS",
        "json" => "JSON",
        "xml" => "XML",
        "bash" or "sh" or "shell" => "Shell",
        "ps" or "ps1" or "powershell" => "PowerShell",
        _ => Language
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await HighlightCode();
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Only re-highlight if code or language changed
        if (Code != previousCode || Language != previousLanguage)
        {
            previousCode = Code;
            previousLanguage = Language;

            if (!string.IsNullOrEmpty(Code))
            {
                await HighlightCode();
            }
        }
    }

    private async Task HighlightCode()
    {
        if (string.IsNullOrEmpty(Code)) return;

        try
        {
            // Detect theme from document
            var isDark = await JS.InvokeAsync<bool>("eval", "document.documentElement.classList.contains('dark')");
            var theme = isDark ? "dark" : "light";

            highlightedHtml = await JS.InvokeAsync<string>("highlightCode", Code, Language, theme);
            StateHasChanged();
        }
        catch
        {
            // Shiki not available, keep fallback
            highlightedHtml = null;
        }
    }
}
