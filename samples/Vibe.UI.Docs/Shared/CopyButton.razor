@implements IDisposable

<button class="@ButtonClasses"
        data-copy-text-b64="@CopyTextB64"
        @onclick="CopyToClipboard"
        title="@(Copied ? "Copy to clipboard (Copied!)" : "Copy to clipboard")">
    @if (Copied)
    {
        <!-- Check icon with bounce animation -->
        <svg class="vibe-w-4 vibe-h-4 vibe-text-green-500 vibe-copy-success-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        @if (ShowText)
        {
            <span class="vibe-text-green-500">Copied!</span>
        }
    }
    else
    {
        <!-- Copy icon -->
        <svg class="vibe-w-4 vibe-h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
        </svg>
        @if (ShowText)
        {
            <span>Copy</span>
        }
    }
</button>

@code {
    /// <summary>
    /// The code/text to copy to clipboard.
    /// </summary>
    [Parameter]
    public string Code { get; set; } = string.Empty;

    /// <summary>
    /// Alias for Code - the text to copy to clipboard.
    /// </summary>
    [Parameter]
    public string Text
    {
        get => Code;
        set => Code = value;
    }

    /// <summary>
    /// Whether to show the "Copy"/"Copied!" text label.
    /// </summary>
    [Parameter]
    public bool ShowText { get; set; } = true;

    /// <summary>
    /// Visual variant of the button.
    /// </summary>
    [Parameter]
    public CopyButtonVariant Variant { get; set; } = CopyButtonVariant.Default;

    /// <summary>
    /// Additional CSS classes to apply.
    /// </summary>
    [Parameter]
    public string? Class { get; set; }

    private bool Copied { get; set; }
    private System.Threading.CancellationTokenSource? _cts;

    private string ButtonClasses
    {
        get
        {
            var baseClasses = "vibe-inline-flex vibe-items-center vibe-gap-1.5 vibe-transition-all vibe-duration-200 focus:vibe-outline-none focus:vibe-ring-2 focus:vibe-ring-brand-teal";

            var variantClasses = Variant switch
            {
                CopyButtonVariant.Ghost => "vibe-p-1.5 vibe-rounded-md hover:vibe-bg-zinc-100 dark:hover:vibe-bg-zinc-800 vibe-text-zinc-500 hover:vibe-text-zinc-700 dark:hover:vibe-text-zinc-300",
                CopyButtonVariant.Outline => "vibe-px-3 vibe-py-1.5 vibe-rounded-md vibe-border vibe-border-zinc-200 dark:vibe-border-zinc-700 hover:vibe-bg-zinc-50 dark:hover:vibe-bg-zinc-800 vibe-text-zinc-600 dark:vibe-text-zinc-400 vibe-text-sm",
                _ => "vibe-px-3 vibe-py-1.5 vibe-rounded-md vibe-bg-zinc-100 dark:vibe-bg-zinc-800 hover:vibe-bg-zinc-200 dark:hover:vibe-bg-zinc-700 vibe-text-zinc-600 dark:vibe-text-zinc-300 vibe-text-sm vibe-font-medium"
            };

            return $"{baseClasses} {variantClasses} {Class}".Trim();
        }
    }

    private async Task CopyToClipboard()
    {
        if (string.IsNullOrEmpty(Code)) return;

        // Cancel any previous reset timer
        _cts?.Cancel();
        _cts = new System.Threading.CancellationTokenSource();

        Copied = true;
        StateHasChanged();

        // Reset after 2 seconds
        try
        {
            await Task.Delay(2000, _cts.Token);
            Copied = false;
            StateHasChanged();
        }
        catch (TaskCanceledException)
        {
            // Ignore - timer was cancelled
        }
    }

    private string CopyTextB64 =>
        Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(Code ?? string.Empty));

    public void Dispose()
    {
        _cts?.Cancel();
        _cts?.Dispose();
    }

    public enum CopyButtonVariant
    {
        Default,
        Ghost,
        Outline
    }
}
