@using Vibe.UI.Docs.Models

@*
    PropTweaker - Interactive property controls for component demos
    Allows users to tweak Variant, Size, Disabled, and other props in real-time
*@

<div class="prop-tweaker @(IsOpen ? "open" : "")">
    <!-- Header -->
    <div class="vibe-flex vibe-items-center vibe-justify-between vibe-px-4 vibe-py-3 vibe-border-b vibe-border-zinc-200 dark:vibe-border-zinc-800">
        <h3 class="vibe-text-sm vibe-font-semibold vibe-text-zinc-900 dark:vibe-text-zinc-100">Properties</h3>
        <button class="vibe-p-1 vibe-rounded hover:vibe-bg-zinc-100 dark:hover:vibe-bg-zinc-800 vibe-transition-colors"
                @onclick="Reset"
                title="Reset to defaults">
            <svg class="vibe-w-4 vibe-h-4 vibe-text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
        </button>
    </div>

    <!-- Props List -->
    <div class="vibe-p-4 vibe-space-y-4 vibe-overflow-y-auto vibe-max-h-[400px]">
        @foreach (var prop in Props)
        {
            <div class="vibe-space-y-1.5">
                <!-- Label -->
                <label class="vibe-flex vibe-items-center vibe-justify-between vibe-text-sm">
                    <span class="vibe-font-medium vibe-text-zinc-700 dark:vibe-text-zinc-300">@prop.Name</span>
                    @if (prop.Type == PropType.Boolean)
                    {
                        <!-- Boolean Toggle -->
                        <button class="vibe-relative vibe-w-10 vibe-h-5 vibe-rounded-full vibe-transition-colors @(IsTrue(prop.Value) ? "vibe-bg-brand-teal" : "vibe-bg-zinc-300 dark:vibe-bg-zinc-600")"
                                @onclick="() => ToggleBool(prop)">
                            <span class="vibe-absolute vibe-top-0.5 vibe-left-0.5 vibe-w-4 vibe-h-4 vibe-bg-white vibe-rounded-full vibe-shadow vibe-transition-transform @(IsTrue(prop.Value) ? "vibe-translate-x-5" : "")"></span>
                        </button>
                    }
                </label>

                @if (prop.Description != null)
                {
                    <p class="vibe-text-xs vibe-text-zinc-500">@prop.Description</p>
                }

                @switch (prop.Type)
                {
                    case PropType.Enum:
                        <!-- Enum Selector (Button Group) -->
                        <div class="vibe-flex vibe-flex-wrap vibe-gap-1">
                            @foreach (var option in prop.Options)
                            {
                                var isSelected = prop.Value?.ToString() == option;
                                <button class="vibe-px-2.5 vibe-py-1 vibe-text-xs vibe-font-medium vibe-rounded-md vibe-transition-colors @(isSelected ? "vibe-bg-brand-teal vibe-text-white" : "vibe-bg-zinc-100 dark:vibe-bg-zinc-800 vibe-text-zinc-600 dark:vibe-text-zinc-400 hover:vibe-bg-zinc-200 dark:hover:vibe-bg-zinc-700")"
                                        @onclick="() => SelectOption(prop, option)">
                                    @option
                                </button>
                            }
                        </div>
                        break;

                    case PropType.String:
                        <!-- String Input -->
                        <input type="text"
                               value="@prop.Value?.ToString()"
                               @onchange="e => SetValue(prop, e.Value)"
                               class="vibe-w-full vibe-px-3 vibe-py-1.5 vibe-text-sm vibe-rounded-md vibe-border vibe-border-zinc-200 dark:vibe-border-zinc-700 vibe-bg-white dark:vibe-bg-zinc-800 vibe-text-zinc-900 dark:vibe-text-zinc-100 focus:vibe-outline-none focus:vibe-ring-2 focus:vibe-ring-brand-teal/50" />
                        break;

                    case PropType.Number:
                        <!-- Number Input -->
                        <div class="vibe-flex vibe-items-center vibe-gap-2">
                            <input type="range"
                                   min="@(prop.Min ?? 0)"
                                   max="@(prop.Max ?? 100)"
                                   step="@(prop.Step ?? 1)"
                                   value="@prop.Value"
                                   @onchange="e => HandleNumberChange(prop, e)"
                                   class="vibe-flex-1 vibe-h-1.5 vibe-bg-zinc-200 dark:vibe-bg-zinc-700 vibe-rounded-full vibe-appearance-none vibe-cursor-pointer" />
                            <span class="vibe-w-10 vibe-text-xs vibe-text-zinc-500 vibe-text-right">@prop.Value</span>
                        </div>
                        break;

                    case PropType.Color:
                        <!-- Color Picker -->
                        <div class="vibe-flex vibe-items-center vibe-gap-2">
                            <input type="color"
                                   value="@prop.Value?.ToString()"
                                   @onchange="e => SetValue(prop, e.Value)"
                                   class="vibe-w-8 vibe-h-8 vibe-rounded vibe-border vibe-border-zinc-200 dark:vibe-border-zinc-700 vibe-cursor-pointer" />
                            <span class="vibe-text-xs vibe-text-zinc-500 vibe-font-mono">@prop.Value</span>
                        </div>
                        break;

                    case PropType.Boolean:
                        <!-- Already handled above as toggle -->
                        break;
                }
            </div>
        }

        @if (!Props.Any())
        {
            <p class="vibe-text-sm vibe-text-zinc-500 vibe-text-center vibe-py-4">No properties to configure</p>
        }
    </div>

    <!-- Generated Code Preview -->
    @if (ShowCodePreview && Props.Any())
    {
        <div class="vibe-border-t vibe-border-zinc-200 dark:vibe-border-zinc-800 vibe-p-4">
            <div class="vibe-flex vibe-items-center vibe-justify-between vibe-mb-2">
                <span class="vibe-text-xs vibe-font-medium vibe-text-zinc-500 vibe-uppercase vibe-tracking-wider">Generated Props</span>
                <CopyButton Text="@GeneratedCode" Variant="CopyButton.CopyButtonVariant.Ghost" />
            </div>
            <pre class="vibe-text-xs vibe-font-mono vibe-text-zinc-600 dark:vibe-text-zinc-400 vibe-bg-zinc-50 dark:vibe-bg-zinc-800/50 vibe-rounded-md vibe-p-2 vibe-overflow-x-auto"><code>@GeneratedCode</code></pre>
        </div>
    }
</div>

<style>
    .prop-tweaker {
        background: white;
        border-radius: 0.75rem;
        border: 1px solid rgb(228 228 231);
        overflow: hidden;
    }

    :global(.dark) .prop-tweaker {
        background: rgb(24 24 27);
        border-color: rgb(39 39 42);
    }

    /* Custom range input styling */
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 14px;
        height: 14px;
        background: #065465;
        border-radius: 50%;
        cursor: pointer;
    }

    input[type="range"]::-moz-range-thumb {
        width: 14px;
        height: 14px;
        background: #065465;
        border-radius: 50%;
        cursor: pointer;
        border: none;
    }
</style>

@code {
    /// <summary>
    /// The list of property definitions to display.
    /// </summary>
    [Parameter]
    public List<PropDefinition> Props { get; set; } = new();

    /// <summary>
    /// Whether the tweaker panel is open/visible.
    /// </summary>
    [Parameter]
    public bool IsOpen { get; set; } = true;

    /// <summary>
    /// Whether to show the generated code preview.
    /// </summary>
    [Parameter]
    public bool ShowCodePreview { get; set; } = true;

    /// <summary>
    /// Callback when any property value changes.
    /// </summary>
    [Parameter]
    public EventCallback<PropDefinition> OnPropChanged { get; set; }

    /// <summary>
    /// Callback when props are reset to defaults.
    /// </summary>
    [Parameter]
    public EventCallback OnReset { get; set; }

    private bool IsTrue(object? value) => value is true || value?.ToString()?.ToLower() == "true";

    private async Task ToggleBool(PropDefinition prop)
    {
        prop.Value = !IsTrue(prop.Value);
        await OnPropChanged.InvokeAsync(prop);
    }

    private async Task SelectOption(PropDefinition prop, string option)
    {
        prop.Value = option;
        await OnPropChanged.InvokeAsync(prop);
    }

    private async Task SetValue(PropDefinition prop, object? value)
    {
        prop.Value = value;
        await OnPropChanged.InvokeAsync(prop);
    }

    private async Task HandleNumberChange(PropDefinition prop, ChangeEventArgs e)
    {
        if (double.TryParse(e.Value?.ToString(), out var value))
        {
            await SetValue(prop, value);
        }
    }

    private async Task Reset()
    {
        foreach (var prop in Props)
        {
            prop.Value = prop.DefaultValue;
        }
        await OnReset.InvokeAsync();
    }

    private string GeneratedCode
    {
        get
        {
            var nonDefaultProps = Props
                .Where(p => !Equals(p.Value, p.DefaultValue))
                .Select(p => p.Type switch
                {
                    PropType.Boolean => $"{p.Name}=\"{p.Value.ToString()?.ToLower()}\"",
                    PropType.String => $"{p.Name}=\"{p.Value}\"",
                    PropType.Number => $"{p.Name}=\"{p.Value}\"",
                    PropType.Enum => $"{p.Name}=\"{p.Name}.{p.Value}\"",
                    PropType.Color => $"{p.Name}=\"{p.Value}\"",
                    _ => $"{p.Name}=\"{p.Value}\""
                });

            return string.Join(" ", nonDefaultProps);
        }
    }
}
