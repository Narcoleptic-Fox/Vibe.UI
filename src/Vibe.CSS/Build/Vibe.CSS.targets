<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- Default properties -->
  <PropertyGroup>
    <VibeCssEnabled Condition="'$(VibeCssEnabled)' == ''">true</VibeCssEnabled>
    <VibeCssOutput Condition="'$(VibeCssOutput)' == ''">$(MSBuildProjectDirectory)\wwwroot\css\vibe.css</VibeCssOutput>
    <VibeCssPrefix Condition="'$(VibeCssPrefix)' == ''">vibe</VibeCssPrefix>
    <VibeCssIncludeBase Condition="'$(VibeCssIncludeBase)' == ''">true</VibeCssIncludeBase>
    <VibeCssScanPatterns Condition="'$(VibeCssScanPatterns)' == ''">*.razor,*.cshtml,*.html</VibeCssScanPatterns>
    <VibeCssUseDotnetToolFallback Condition="'$(VibeCssUseDotnetToolFallback)' == ''">false</VibeCssUseDotnetToolFallback>
    <VibeCssFailOnMissingTool Condition="'$(VibeCssFailOnMissingTool)' == ''">false</VibeCssFailOnMissingTool>

    <!-- Tool assembly path resolution (package-relative) -->
    <_VibeCssToolFromTools>$(MSBuildThisFileDirectory)..\tools\net9.0\Vibe.CSS.dll</_VibeCssToolFromTools>
    <_VibeCssToolFromToolsAny>$(MSBuildThisFileDirectory)..\tools\net9.0\any\Vibe.CSS.dll</_VibeCssToolFromToolsAny>
    <_VibeCssToolFromLib>$(MSBuildThisFileDirectory)..\lib\net9.0\Vibe.CSS.dll</_VibeCssToolFromLib>

    <VibeCssToolPath Condition="'$(VibeCssToolPath)' == '' and Exists('$(_VibeCssToolFromTools)')">$(_VibeCssToolFromTools)</VibeCssToolPath>
    <VibeCssToolPath Condition="'$(VibeCssToolPath)' == '' and Exists('$(_VibeCssToolFromToolsAny)')">$(_VibeCssToolFromToolsAny)</VibeCssToolPath>
    <VibeCssToolPath Condition="'$(VibeCssToolPath)' == '' and Exists('$(_VibeCssToolFromLib)')">$(_VibeCssToolFromLib)</VibeCssToolPath>
    <VibeCssToolPath Condition="'$(VibeCssToolPath)' == ''">$(_VibeCssToolFromTools)</VibeCssToolPath>
  </PropertyGroup>

  <!-- Run CSS generation before build -->
  <Target Name="VibeCssGenerate"
          BeforeTargets="BeforeBuild"
          Condition="'$(VibeCssEnabled)' == 'true'">

    <Message Importance="high" Text="Vibe.CSS: Generating CSS from $(MSBuildProjectDirectory)..." />

    <!-- Determine include-base flag -->
    <PropertyGroup>
      <_VibeCssIncludeBaseArg Condition="'$(VibeCssIncludeBase)' == 'true'">--with-base</_VibeCssIncludeBaseArg>
      <_VibeCssIncludeBaseArg Condition="'$(VibeCssIncludeBase)' != 'true'">--with-base false</_VibeCssIncludeBaseArg>
    </PropertyGroup>

    <Error Condition="!Exists('$(VibeCssToolPath)') and '$(VibeCssFailOnMissingTool)' == 'true'"
           Text="Vibe.CSS: Tool assembly not found at $(VibeCssToolPath). Set VibeCssToolPath or update your Vibe.CSS package restore." />

    <Warning Condition="!Exists('$(VibeCssToolPath)') and '$(VibeCssFailOnMissingTool)' != 'true' and '$(VibeCssUseDotnetToolFallback)' != 'true'"
             Text="Vibe.CSS: Tool assembly not found at $(VibeCssToolPath); skipping CSS generation. Set VibeCssToolPath or set VibeCssUseDotnetToolFallback=true to try a dotnet tool." />

    <!-- Call Vibe.CSS via dotnet exec (preferred when referenced via PackageReference) -->
    <Exec Command="dotnet &quot;$(VibeCssToolPath)&quot; generate &quot;$(MSBuildProjectDirectory)&quot; -o &quot;$(VibeCssOutput)&quot; --prefix $(VibeCssPrefix) $(_VibeCssIncludeBaseArg) --patterns=$(VibeCssScanPatterns)"
          Condition="Exists('$(VibeCssToolPath)')"
          ConsoleToMSBuild="true"
          StandardOutputImportance="Normal"
          StandardErrorImportance="High" />

    <!-- Optional fallback: Use dotnet tool if package assembly isn't available -->
    <Exec Command="dotnet vibe-css generate &quot;$(MSBuildProjectDirectory)&quot; -o &quot;$(VibeCssOutput)&quot; --prefix $(VibeCssPrefix) $(_VibeCssIncludeBaseArg) --patterns=$(VibeCssScanPatterns)"
          Condition="!Exists('$(VibeCssToolPath)') and '$(VibeCssUseDotnetToolFallback)' == 'true'"
          ConsoleToMSBuild="true"
          StandardOutputImportance="Normal"
          StandardErrorImportance="High" />

    <Message Importance="high" Text="Vibe.CSS: Generated $(VibeCssOutput)" Condition="Exists('$(VibeCssOutput)')" />
  </Target>

  <!-- Clean generated CSS -->
  <Target Name="VibeCssClean" AfterTargets="Clean">
    <Delete Files="$(VibeCssOutput)" Condition="Exists('$(VibeCssOutput)')" />
    <Message Importance="Normal" Text="Vibe.CSS: Cleaned $(VibeCssOutput)" />
  </Target>

</Project>
