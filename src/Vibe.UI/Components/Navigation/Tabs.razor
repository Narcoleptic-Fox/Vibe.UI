@namespace Vibe.UI.Components
@inherits Vibe.UI.Base.VibeComponent
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div class="@CombinedClass" @attributes="AdditionalAttributes">
    <div class="vibe-tabs-list" role="tablist" aria-orientation="horizontal">
        @foreach (var tab in _tabs)
        {
            var isActive = tab.Id == ActiveTabId;
            <button type="button" class="vibe-tabs-trigger @(tab.Id == ActiveTabId ? "vibe-tabs-trigger-active" : "")"
                id="@GetTabTriggerId(tab.Id)"
                role="tab"
                aria-selected="@(isActive ? "true" : "false")"
                aria-controls="@GetTabPanelId(tab.Id)"
                tabindex="@(isActive ? 0 : -1)"
                disabled="@(tab.Disabled)"
                @onclick="() => ActivateTab(tab.Id)"
                @onkeydown="(e) => OnTriggerKeyDown(e, tab.Id)">
                @tab.Title
            </button>
        }
    </div>
    <div class="vibe-tabs-content">
        @foreach (var tab in _tabs)
        {
            var isActive = tab.Id == ActiveTabId;
            <div class="vibe-tabs-panel @(isActive ? "vibe-tabs-panel-active" : "")"
                role="tabpanel"
                id="@GetTabPanelId(tab.Id)"
                aria-labelledby="@GetTabTriggerId(tab.Id)"
                hidden="@(!isActive)"
                tabindex="0">
                @tab.Content
            </div>
        }
    </div>
</div>

@code {
    private List<TabItem> _tabs = new();
    private IJSObjectReference? _domModule;

    /// <summary>
    /// Gets or sets the active tab ID
    /// </summary>
    [Parameter]
    public string ActiveTabId { get; set; }

    /// <summary>
    /// Gets or sets the callback for when the active tab changes
    /// </summary>
    [Parameter]
    public EventCallback<string> ActiveTabIdChanged { get; set; }

    /// <summary>
    /// Gets or sets the callback for when a tab is activated
    /// </summary>
    [Parameter]
    public EventCallback<TabActivatedEventArgs> OnTabActivated { get; set; }

    /// <summary>
    /// Gets or sets the tab items
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <inheritdoc/>
    protected override string ComponentClass => "vibe-tabs";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _domModule = await JSRuntime.InvokeAsync<IJSObjectReference>(
                "import", "./_content/Vibe.UI/js/vibe-dom.js");
        }
    }

    /// <summary>
    /// Initializes the component
    /// </summary>
    protected override void OnInitialized()
    {
        base.OnInitialized();
    }

    /// <summary>
    /// Adds a tab to the collection
    /// </summary>
    /// <param name="tab">The tab to add</param>
    internal void AddTab(TabItem tab)
    {
        _tabs.Add(tab);

        // If this is the first tab or if it's set to be the default active tab,
        // make it the active tab
        if ((string.IsNullOrEmpty(ActiveTabId) && _tabs.Count == 1) ||
        tab.DefaultActive)
        {
            ActiveTabId = tab.Id;
        }

        StateHasChanged();
    }

    /// <summary>
    /// Removes a tab from the collection
    /// </summary>
    /// <param name="tabId">The ID of the tab to remove</param>
    internal void RemoveTab(string tabId)
    {
        var tab = _tabs.FirstOrDefault(t => t.Id == tabId);
        if (tab != null)
        {
            _tabs.Remove(tab);

            // If the removed tab was the active tab, activate the first tab that's not disabled
            if (tabId == ActiveTabId && _tabs.Count > 0)
            {
                var nextTab = _tabs.FirstOrDefault(t => !t.Disabled);
                if (nextTab != null)
                {
                    ActiveTabId = nextTab.Id;
                }
            }

            StateHasChanged();
        }
    }

    /// <summary>
    /// Activates a tab
    /// </summary>
    /// <param name="tabId">The ID of the tab to activate</param>
    private async Task ActivateTab(string tabId)
    {
        var tab = _tabs.FirstOrDefault(t => t.Id == tabId);
        if (tab != null && !tab.Disabled && tabId != ActiveTabId)
        {
            ActiveTabId = tabId;

            if (ActiveTabIdChanged.HasDelegate)
            {
                await ActiveTabIdChanged.InvokeAsync(tabId);
            }

            if (OnTabActivated.HasDelegate)
            {
                await OnTabActivated.InvokeAsync(new TabActivatedEventArgs(tabId, tab.Title));
            }
        }
    }

    private async Task OnTriggerKeyDown(KeyboardEventArgs e, string currentTabId)
    {
        if (_tabs.Count == 0)
            return;

        var currentIndex = _tabs.FindIndex(t => t.Id == currentTabId);
        if (currentIndex < 0)
            return;

        string? nextId = e.Key switch
        {
            "ArrowRight" => FindNextEnabledTabId(currentIndex, forward: true),
            "ArrowLeft" => FindNextEnabledTabId(currentIndex, forward: false),
            "Home" => FindNextEnabledTabId(startIndex: -1, forward: true),
            "End" => FindNextEnabledTabId(startIndex: _tabs.Count, forward: false),
            _ => null
        };

        if (nextId == null)
            return;

        await ActivateTab(nextId);
        await FocusTriggerAsync(nextId);
    }

    private string? FindNextEnabledTabId(int startIndex, bool forward)
    {
        if (_tabs.Count == 0)
            return null;

        var index = startIndex;
        for (var i = 0; i < _tabs.Count; i++)
        {
            index = forward ? (index + 1) % _tabs.Count : (index - 1 + _tabs.Count) % _tabs.Count;
            if (!_tabs[index].Disabled)
                return _tabs[index].Id;
        }

        return null;
    }

    private async Task FocusTriggerAsync(string tabId)
    {
        if (_domModule == null)
            return;

        await _domModule.InvokeVoidAsync("focusElement", GetTabTriggerId(tabId));
    }

    private static string GetTabPanelId(string tabId) => $"vibe-tabpanel-{tabId}";
    private static string GetTabTriggerId(string tabId) => $"vibe-tab-{tabId}";

    public async ValueTask DisposeAsync()
    {
        if (_domModule != null)
        {
            await _domModule.DisposeAsync();
        }
    }

    /// <summary>
    /// Tab item
    /// </summary>
    internal class TabItem
    {
        /// <summary>
        /// Gets the ID of the tab
        /// </summary>
        public string Id { get; }

        /// <summary>
        /// Gets the title of the tab
        /// </summary>
        public RenderFragment Title { get; }

        /// <summary>
        /// Gets the content of the tab
        /// </summary>
        public RenderFragment Content { get; }

        /// <summary>
        /// Gets whether the tab is disabled
        /// </summary>
        public bool Disabled { get; }

        /// <summary>
        /// Gets whether the tab should be active by default
        /// </summary>
        public bool DefaultActive { get; }

        /// <summary>
        /// Creates a new instance of <see cref="TabItem"/>
        /// </summary>
        /// <param name="id">The ID of the tab</param>
        /// <param name="title">The title of the tab</param>
        /// <param name="content">The content of the tab</param>
        /// <param name="disabled">Whether the tab is disabled</param>
        /// <param name="defaultActive">Whether the tab should be active by default</param>
        public TabItem(string id, RenderFragment title, RenderFragment content, bool disabled, bool defaultActive)
        {
            Id = id;
            Title = title;
            Content = content;
            Disabled = disabled;
            DefaultActive = defaultActive;
        }
    }

    /// <summary>
    /// Tab activated event arguments
    /// </summary>
    public class TabActivatedEventArgs
    {
        /// <summary>
        /// Gets the ID of the tab
        /// </summary>
        public string TabId { get; }

        /// <summary>
        /// Gets the title of the tab as a string (for convenience)
        /// </summary>
        public RenderFragment Title { get; }

        /// <summary>
        /// Creates a new instance of <see cref="TabActivatedEventArgs"/>
        /// </summary>
        /// <param name="tabId">The ID of the tab</param>
        /// <param name="title">The title of the tab</param>
        public TabActivatedEventArgs(string tabId, RenderFragment title)
        {
            TabId = tabId;
            Title = title;
        }
    }
}