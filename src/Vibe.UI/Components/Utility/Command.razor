@namespace Vibe.UI.Components
@inherits Base.VibeComponent
@inject IJSRuntime JS
@implements IAsyncDisposable

<div class="@CombinedClass" @attributes="AdditionalAttributes">
    <div class="command-input-wrapper">
        @if (!string.IsNullOrEmpty(Icon))
        {
            <div class="command-input-icon">@((MarkupString)Icon)</div>
        }
        <input
            @ref="InputRef"
            type="text"
            class="command-input"
            placeholder="@Placeholder"
            role="combobox"
            aria-autocomplete="list"
            aria-controls="@_listboxId"
            aria-expanded="@(FilteredItems.Any() ? "true" : "false")"
            aria-activedescendant="@ActiveDescendantId"
            value="@InputValue"
            @oninput="OnInputChanged"
            @onkeydown="OnKeyDown" 
            @onfocus="OnFocus"
            @onblur="OnBlur"
            autocomplete="off"
            autocorrect="off"
            spellcheck="false" />
    </div>

    <div class="command-separator"></div>

    <div class="command-list" role="listbox" id="@_listboxId">
        @if (FilteredItems.Any())
        {
            @for (var i = 0; i < FilteredItems.Count; i++)
            {
                var item = FilteredItems[i];
                var isSelected = SelectedIndex == i;
                var optionId = GetOptionId(i);
                <div 
                    id="@optionId"
                    role="option"
                    aria-selected="@(isSelected ? "true" : "false")"
                    aria-disabled="@(item.Disabled ? "true" : "false")"
                    class="command-item @(isSelected ? "selected" : "") @(item.Disabled ? "disabled" : "")"
                    @onclick="() => OnItemSelected(item)"
                    @onmouseenter="() => OnHoverIndexChanged(i)">
                    <span class="command-item-label">@item.Label</span>
                    @if (!string.IsNullOrEmpty(item.Shortcut))
                    {
                        <span class="command-item-shortcut">@item.Shortcut</span>
                    }
                </div>
            }
        }
        else
        {
            <div class="command-empty">No results found.</div>
        }
    </div>
</div>

@code {
    /// <summary>
    /// Represents an item in the command list.
    /// </summary>
    public class CommandItem
    {
        /// <summary>
        /// Gets or sets the item's label.
        /// </summary>
        public string Label { get; set; }

        /// <summary>
        /// Gets or sets the item's value.
        /// </summary>
        public string Value { get; set; }

        /// <summary>
        /// Gets or sets the item's keyboard shortcut.
        /// </summary>
        public string Shortcut { get; set; }

        /// <summary>
        /// Gets or sets whether the item is disabled.
        /// </summary>
        public bool Disabled { get; set; }
    }

    /// <summary>
    /// Gets or sets the placeholder text for the command input.
    /// </summary>
    [Parameter]
    public string Placeholder { get; set; } = "Type a command or search...";

    /// <summary>
    /// Gets or sets the items to display in the command list.
    /// </summary>
    [Parameter]
    public List<CommandItem> Items { get; set; } = new List<CommandItem>();

    /// <summary>
    /// Gets or sets the icon for the command input.
    /// </summary>
    [Parameter]
    public string Icon { get; set; } = "<svg width=\"15\" height=\"15\" viewBox=\"0 0 15 15\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M10 6.5C10 8.433 8.433 10 6.5 10C4.567 10 3 8.433 3 6.5C3 4.567 4.567 3 6.5 3C8.433 3 10 4.567 10 6.5ZM9.30884 10.0159C8.53901 10.6318 7.56251 11 6.5 11C4.01472 11 2 8.98528 2 6.5C2 4.01472 4.01472 2 6.5 2C8.98528 2 11 4.01472 11 6.5C11 7.56251 10.6318 8.53901 10.0159 9.30884L12.8536 12.1464C13.0488 12.3417 13.0488 12.6583 12.8536 12.8536C12.6583 13.0488 12.3417 13.0488 12.1464 12.8536L9.30884 10.0159Z\" fill=\"currentColor\" fill-rule=\"evenodd\" clip-rule=\"evenodd\"></path></svg>";

    /// <summary>
    /// Gets or sets the callback for when an item is selected.
    /// </summary>
    [Parameter]
    public EventCallback<CommandItem> ItemSelected { get; set; }

    /// <summary>
    /// Gets the component CSS class name.
    /// </summary>
    protected override string ComponentClass => "vibe-command";

    /// <summary>
    /// Reference to the input element.
    /// </summary>
    private ElementReference InputRef;

    /// <summary>
    /// The current input value.
    /// </summary>
    private string _inputValue = string.Empty;
    private IJSObjectReference? _domModule;
    private readonly string _instanceId = Guid.NewGuid().ToString("N");
    private string _listboxId => $"vibe-command-listbox-{_instanceId}";

    /// <summary>
    /// The index of the currently selected item.
    /// </summary>
    private int SelectedIndex = -1;

    /// <summary>
    /// Gets the filtered items based on the input value.
    /// </summary>
    private List<CommandItem> FilteredItems =>
        string.IsNullOrWhiteSpace(InputValue)
            ? Items.ToList()
            : Items.Where(i => i.Label.Contains(InputValue, StringComparison.OrdinalIgnoreCase) ||
                              i.Value?.Contains(InputValue, StringComparison.OrdinalIgnoreCase) == true)
                  .ToList();

    /// <summary>
    /// Checks if the given item is the selected one.
    /// </summary>
    /// <param name="item">The item to check.</param>
    /// <returns>True if the item is selected, false otherwise.</returns>
    private string InputValue
    {
        get => _inputValue;
        set
        {
            if (_inputValue == value)
                return;

            _inputValue = value;
            SelectedIndex = FindFirstEnabledIndex();
        }
    }

    private string? ActiveDescendantId =>
        SelectedIndex >= 0 && SelectedIndex < FilteredItems.Count ? GetOptionId(SelectedIndex) : null;

    /// <summary>
    /// Handles keyboard navigation.
    /// </summary>
    /// <param name="e">The keyboard event args.</param>
    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (!FilteredItems.Any())
            return;

        switch (e.Key)
        {
            case "ArrowDown":
                MoveSelection(forward: true);
                await ScrollSelectedIntoViewAsync();
                break;
                
            case "ArrowUp":
                MoveSelection(forward: false);
                await ScrollSelectedIntoViewAsync();
                break;

            case "Home":
                SelectedIndex = FindFirstEnabledIndex();
                await ScrollSelectedIntoViewAsync();
                break;

            case "End":
                SelectedIndex = FindLastEnabledIndex();
                await ScrollSelectedIntoViewAsync();
                break;
                
            case "Enter":
                if (SelectedIndex >= 0 && SelectedIndex < FilteredItems.Count)
                {
                    await OnItemSelected(FilteredItems[SelectedIndex]);
                }
                break;

            case "Escape":
                InputValue = string.Empty;
                break;
        }
    }

    /// <summary>
    /// Handles when an item is selected.
    /// </summary>
    /// <param name="item">The selected item.</param>
    private async Task OnItemSelected(CommandItem item)
    {
        if (!item.Disabled)
        {
            InputValue = string.Empty;
            await ItemSelected.InvokeAsync(item);
        }
    }

    private void OnHoverIndexChanged(int index)
    {
        if (index < 0 || index >= FilteredItems.Count)
            return;

        if (FilteredItems[index].Disabled)
            return;

        SelectedIndex = index;
    }

    private async Task OnInputChanged(ChangeEventArgs e)
    {
        InputValue = e.Value?.ToString() ?? string.Empty;
        await InvokeAsync(StateHasChanged);
    }

    /// <summary>
    /// Handles when the input is focused.
    /// </summary>
    private void OnFocus()
    {
        // Reset selection on focus
        SelectedIndex = FindFirstEnabledIndex();
    }

    /// <summary>
    /// Handles when the input loses focus.
    /// </summary>
    private void OnBlur()
    {
        // Optional: could implement timeout before closing
    }

    /// <summary>
    /// Focuses the command input.
    /// </summary>
    public async Task FocusAsync()
    {
        await InputRef.FocusAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _domModule = await JS.InvokeAsync<IJSObjectReference>(
                "import", "./_content/Vibe.UI/js/vibe-dom.js");
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_domModule != null)
        {
            await _domModule.DisposeAsync();
        }
    }

    private string GetOptionId(int index) => $"vibe-command-option-{_instanceId}-{index}";

    private int FindFirstEnabledIndex()
    {
        for (var i = 0; i < FilteredItems.Count; i++)
        {
            if (!FilteredItems[i].Disabled)
                return i;
        }

        return -1;
    }

    private int FindLastEnabledIndex()
    {
        for (var i = FilteredItems.Count - 1; i >= 0; i--)
        {
            if (!FilteredItems[i].Disabled)
                return i;
        }

        return -1;
    }

    private void MoveSelection(bool forward)
    {
        if (FilteredItems.Count == 0)
        {
            SelectedIndex = -1;
            return;
        }

        var start = SelectedIndex;
        if (start < 0 || start >= FilteredItems.Count)
        {
            SelectedIndex = FindFirstEnabledIndex();
            return;
        }

        var index = start;
        for (var i = 0; i < FilteredItems.Count; i++)
        {
            index = forward ? (index + 1) % FilteredItems.Count : (index - 1 + FilteredItems.Count) % FilteredItems.Count;
            if (!FilteredItems[index].Disabled)
            {
                SelectedIndex = index;
                return;
            }
        }

        SelectedIndex = -1;
    }

    private async Task ScrollSelectedIntoViewAsync()
    {
        if (_domModule == null)
            return;

        if (SelectedIndex < 0 || SelectedIndex >= FilteredItems.Count)
            return;

        await _domModule.InvokeVoidAsync("scrollIntoView", GetOptionId(SelectedIndex), new { behavior = "auto", block = "nearest" });
    }
}
