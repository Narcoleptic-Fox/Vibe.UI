@namespace Vibe.UI.Components
@using Microsoft.AspNetCore.Components.Forms
@inherits VibeComponent

<div class="@GetContainerClass()">
    <div class="@GetInputWrapperClass()">
        @if (!string.IsNullOrEmpty(LeadingIcon))
        {
            <span class="vibe-input-icon vibe-input-icon-leading">@((MarkupString)LeadingIcon)</span>
        }
        <input type="@Type" class="@GetInputClass()" id="@Id" placeholder="@GetPlaceholder()" value="@Value"
            @onchange="OnValueChanged" @oninput="OnInput" @onfocus="OnFocus" @onblur="OnBlur" disabled="@Disabled"
            readonly="@ReadOnly" />
        @if (!string.IsNullOrEmpty(Label))
        {
            <label class="@GetLabelClass()" for="@Id">@Label</label>
        }
        @if (!string.IsNullOrEmpty(TrailingIcon))
        {
            <span class="vibe-input-icon vibe-input-icon-trailing">@((MarkupString)TrailingIcon)</span>
        }
    </div>
    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="vibe-input-error-message">@ErrorMessage</div>
    }
    @if (!string.IsNullOrEmpty(HelperText))
    {
        <div class="vibe-input-helper">@HelperText</div>
    }
</div>

@code {
    [Parameter] public string Id { get; set; } = Guid.NewGuid().ToString();
    [Parameter] public string Label { get; set; } = string.Empty;
    [Parameter] public string Type { get; set; } = "text";
    [Parameter] public string Placeholder { get; set; } = string.Empty;
    [Parameter] public string Value { get; set; } = string.Empty;
    [Parameter] public EventCallback<string> ValueChanged { get; set; }
    [Parameter] public bool Disabled { get; set; } = false;
    [Parameter] public bool ReadOnly { get; set; } = false;
    [Parameter] public string LeadingIcon { get; set; } = string.Empty;
    [Parameter] public string TrailingIcon { get; set; } = string.Empty;
    [Parameter] public string ErrorMessage { get; set; } = string.Empty;
    [Parameter] public string HelperText { get; set; } = string.Empty;
    [Parameter] public string Size { get; set; } = "medium"; // small, medium, large
    [Parameter] public string Variant { get; set; } = "outlined"; // text, filled, outlined

    private bool isFocused = false;
    private bool hasValue => !string.IsNullOrEmpty(Value);

    private async Task OnValueChanged(ChangeEventArgs e)
    {
        Value = e.Value?.ToString() ?? string.Empty;
        await ValueChanged.InvokeAsync(Value);
    }

    private async Task OnInput(ChangeEventArgs e)
    {
        Value = e.Value?.ToString() ?? string.Empty;
        await ValueChanged.InvokeAsync(Value);
    }

    private void OnFocus(FocusEventArgs e)
    {
        isFocused = true;
    }

    private void OnBlur(FocusEventArgs e)
    {
        isFocused = false;
    }

    protected override string ComponentClass => GetContainerClass();

    private string GetContainerClass()
    {
        var classes = new List<string> { "vibe-input-container" };
        if (Disabled) classes.Add("vibe-input-disabled");
        if (!string.IsNullOrEmpty(ErrorMessage)) classes.Add("vibe-input-has-error");
        return string.Join(" ", classes);
    }

    private string GetInputWrapperClass()
    {
        var classes = new List<string> { "vibe-input-wrapper" };
        classes.Add($"vibe-input-wrapper-{Variant}");
        classes.Add($"vibe-input-wrapper-{Size}");

        if (isFocused) classes.Add("vibe-input-focused");
        if (hasValue) classes.Add("vibe-input-has-value");
        if (!string.IsNullOrEmpty(ErrorMessage)) classes.Add("vibe-input-error");

        return string.Join(" ", classes);
    }

    private string GetLabelClass()
    {
        var classes = new List<string> { "vibe-input-label" };
        classes.Add($"vibe-input-label-{Variant}");

        if (isFocused || hasValue) classes.Add("vibe-input-label-floating");

        return string.Join(" ", classes);
    }

    private string GetInputClass()
    {
        var classes = new List<string> { "vibe-input" };
        classes.Add($"vibe-input-{Size}");
        classes.Add($"vibe-input-{Variant}");

        if (!string.IsNullOrEmpty(LeadingIcon))
            classes.Add("vibe-input-with-leading-icon");

        if (!string.IsNullOrEmpty(TrailingIcon))
            classes.Add("vibe-input-with-trailing-icon");

        return string.Join(" ", classes);
    }

    private string GetPlaceholder()
    {
        // Only show placeholder when focused or if no label
        if (string.IsNullOrEmpty(Label) || isFocused)
            return Placeholder;

        return string.Empty;
    }
}