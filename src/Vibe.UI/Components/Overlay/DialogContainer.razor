@namespace Vibe.UI.Components
@using Vibe.UI.Services.Dialog
@implements IDisposable
@implements IAsyncDisposable
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime
@inherits Vibe.UI.Base.VibeComponent

@if (_isOpen)
{
    <div class="@CombinedClass" @attributes="AdditionalAttributes">
        <div class="vibe-dialog-overlay" @onclick="HandleBackdropClick" @onkeydown="HandleKeyDown" tabindex="-1">
            <div class="vibe-dialog-container"
                @ref="_dialogRef"
                role="dialog"
                aria-modal="true"
                aria-labelledby="@(_titleId != null ? _titleId : null)"
                @onclick:stopPropagation="true">
                @if (!string.IsNullOrWhiteSpace(_title))
                {
                    <div class="vibe-dialog-header">
                        <h2 class="vibe-dialog-title" id="@_titleId">@_title</h2>
                        @if (ShowCloseButton)
                        {
                            <button class="vibe-dialog-close" @onclick="CloseDialog" type="button" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        }
                    </div>
                }
                <div class="vibe-dialog-body">
                    @_content
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool _isOpen = false;
    private string _title;
    private RenderFragment _content;
    private string _dialogId;
    private string? _titleId;

    private IJSObjectReference? _dialogModule;
    private bool _focusTrapActive;
    private ElementReference _dialogRef;
    private readonly string _dialogKey = $"vibe-dialog-{Guid.NewGuid():N}";

    /// <summary>
    /// Gets or sets whether to show the close button in the dialog header.
    /// </summary>
    [Parameter]
    public bool ShowCloseButton { get; set; } = true;

    /// <summary>
    /// Gets or sets whether to close the dialog when clicking on the backdrop.
    /// </summary>
    [Parameter]
    public bool CloseOnBackdropClick { get; set; } = true;

    [Parameter]
    public bool CloseOnEscape { get; set; } = true;

    /// <summary>
    /// Gets the component CSS class name.
    /// </summary>
    protected override string ComponentClass => "vibe-dialog-host";

    protected override void OnInitialized()
    {
        DialogService.OnDialogOpened += HandleDialogOpened;
        DialogService.OnDialogClosed += HandleDialogClosed;
    }

    private void HandleDialogOpened(object sender, DialogOpenedEventArgs args)
    {
        InvokeAsync(() =>
        {
            _dialogId = args.Id;
            _title = args.Title;
            _titleId = string.IsNullOrWhiteSpace(_title) ? null : $"vibe-dialog-title-{Guid.NewGuid():N}";
            _content = args.Content;
            _isOpen = true;
            StateHasChanged();
        });
    }

    private void HandleDialogClosed(object sender, DialogClosedEventArgs args)
    {
        if (args.Id == _dialogId)
        {
            InvokeAsync(() =>
            {
                _isOpen = false;
                StateHasChanged();
            });
        }
    }

    private void CloseDialog()
    {
        DialogService.Close();
    }

    private void HandleBackdropClick()
    {
        if (CloseOnBackdropClick)
        {
            CloseDialog();
        }
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape" && CloseOnEscape)
        {
            CloseDialog();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_isOpen && !_focusTrapActive)
        {
            _dialogModule ??= await JSRuntime.InvokeAsync<IJSObjectReference>(
                "import", "./_content/Vibe.UI/js/vibe-dialog.js");

            await _dialogModule.InvokeVoidAsync("activate", _dialogKey, _dialogRef);
            _focusTrapActive = true;
        }
        else if (!_isOpen && _focusTrapActive)
        {
            if (_dialogModule != null)
            {
                await _dialogModule.InvokeVoidAsync("deactivate", _dialogKey);
            }

            _focusTrapActive = false;
        }
    }

    public void Dispose()
    {
        DialogService.OnDialogOpened -= HandleDialogOpened;
        DialogService.OnDialogClosed -= HandleDialogClosed;
    }

    public async ValueTask DisposeAsync()
    {
        if (_focusTrapActive && _dialogModule != null)
        {
            await _dialogModule.InvokeVoidAsync("deactivate", _dialogKey);
            _focusTrapActive = false;
        }

        if (_dialogModule != null)
        {
            await _dialogModule.DisposeAsync();
        }
    }
}
