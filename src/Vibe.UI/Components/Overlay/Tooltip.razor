@namespace Vibe.UI.Components
@inherits Base.VibeComponent
@inject IJSRuntime JSRuntime
@implements IDisposable

<div class="@CombinedClass"
    @onmouseenter="OnMouseEnter" @onmouseleave="OnMouseLeave"
    @onfocusin="OnFocusIn" @onfocusout="OnFocusOut"
    @onkeydown="OnKeyDown">
    <div class="trigger">
        @TriggerContent
    </div>
    <div class="tooltip-content @(IsVisible ? "visible" : "")" id="@TooltipId" role="tooltip">
        @Content
    </div>
</div>

@code {
    /// <summary>
    /// Gets or sets the trigger content.
    /// </summary>
    [Parameter]
    public RenderFragment TriggerContent { get; set; }

    /// <summary>
    /// Gets or sets the tooltip content.
    /// </summary>
    [Parameter]
    public RenderFragment Content { get; set; }

    /// <summary>
    /// Gets or sets the placement of the tooltip.
    /// </summary>
    [Parameter]
    public string Placement { get; set; } = "top";

    /// <summary>
    /// Gets or sets the delay before showing the tooltip (in milliseconds).
    /// </summary>
    [Parameter]
    public int DelayMS { get; set; } = 200;

    /// <summary>
    /// Gets the component CSS class name.
    /// </summary>
    protected override string ComponentClass => $"vibe-tooltip vibe-tooltip-{Placement}";

    /// <summary>
    /// Flag to track if the tooltip is visible.
    /// </summary>
    private bool IsVisible = false;

    /// <summary>
    /// Timer for delayed showing of the tooltip.
    /// </summary>
    private System.Timers.Timer? _showTimer;

    private readonly string TooltipId = $"vibe-tooltip-{Guid.NewGuid():N}";

    /// <summary>
    /// Handles when the mouse enters the tooltip trigger.
    /// </summary>
    private void OnMouseEnter()
    {
        StartShowTimer();
    }

    private void OnFocusIn(FocusEventArgs e)
    {
        StartShowTimer();
    }

    /// <summary>
    /// Handles when the mouse leaves the tooltip trigger.
    /// </summary>
    private void OnMouseLeave()
    {
        HideTooltip();
    }

    private void OnFocusOut(FocusEventArgs e)
    {
        HideTooltip();
    }

    private void OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            HideTooltip();
        }
    }

    private void StartShowTimer()
    {
        _showTimer?.Dispose();
        _showTimer = new System.Timers.Timer(DelayMS);
        _showTimer.Elapsed += (_, _) =>
        {
            _ = InvokeAsync(() =>
            {
                IsVisible = true;
                StateHasChanged();
            });
        };
        _showTimer.AutoReset = false;
        _showTimer.Start();
    }

    private void HideTooltip()
    {
        _showTimer?.Dispose();
        _showTimer = null;
        IsVisible = false;
        StateHasChanged();
    }

    /// <summary>
    /// Disposes the component.
    /// </summary>
    public void Dispose()
    {
        _showTimer?.Dispose();
    }
}
