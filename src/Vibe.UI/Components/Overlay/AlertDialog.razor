@namespace Vibe.UI.Components
@inherits Vibe.UI.Base.VibeComponent
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

@if (IsOpen)
{
    <div class="@CombinedClass"
        @attributes="AdditionalAttributes"
        @onkeydown="HandleKeyDown"
        tabindex="-1"
        role="alertdialog"
        aria-modal="true"
        aria-labelledby="@_titleId"
        aria-describedby="@_descriptionId">
        <div class="vibe-alert-dialog-backdrop" @onclick="OnBackdropClicked"></div>

        <div class="vibe-alert-dialog-content" @ref="_contentRef">
            @if (!string.IsNullOrEmpty(Title))
            {
                <div class="vibe-alert-dialog-header">
                    <h2 class="vibe-alert-dialog-title" id="@_titleId">@Title</h2>
                    @if (!string.IsNullOrEmpty(Description))
                    {
                        <p class="vibe-alert-dialog-description" id="@_descriptionId">@Description</p>
                    }
                </div>
            }

            <div class="vibe-alert-dialog-body">
                @ChildContent
            </div>

            @if (Footer != null)
            {
                <div class="vibe-alert-dialog-footer">
                    @Footer
                </div>
            }

            @if (CloseOnBackdropClick || ShowCloseButton)
            {
                <button class="vibe-alert-dialog-close" @onclick="OnCloseClicked" type="button" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            }
        </div>
    </div>
}

@code {
    /// <summary>
    /// Gets or sets the dialog content
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Gets or sets the dialog title
    /// </summary>
    [Parameter]
    public string Title { get; set; } = string.Empty;

    /// <summary>
    /// Gets or sets the dialog description
    /// </summary>
    [Parameter]
    public string Description { get; set; } = string.Empty;

    /// <summary>
    /// Gets or sets the dialog footer content
    /// </summary>
    [Parameter]
    public RenderFragment? Footer { get; set; }

    /// <summary>
    /// Gets or sets whether the dialog is open
    /// </summary>
    [Parameter]
    public bool IsOpen { get; set; }

    /// <summary>
    /// Gets or sets whether to close the dialog when clicking on the backdrop
    /// </summary>
    [Parameter]
    public bool CloseOnBackdropClick { get; set; } = true;

    /// <summary>
    /// Gets or sets whether to show the close button
    /// </summary>
    [Parameter]
    public bool ShowCloseButton { get; set; } = true;

    /// <summary>
    /// Gets or sets whether pressing Escape should close the dialog.
    /// </summary>
    [Parameter]
    public bool CloseOnEscape { get; set; } = true;

    /// <summary>
    /// Event callback when the dialog is closed
    /// </summary>
    [Parameter]
    public EventCallback<bool> IsOpenChanged { get; set; }

    /// <inheritdoc/>
    protected override string ComponentClass => "vibe-alert-dialog";

    private IJSObjectReference? _dialogModule;
    private bool _focusTrapActive;
    private ElementReference _contentRef;
    private readonly string _dialogKey = $"vibe-alert-dialog-{Guid.NewGuid():N}";
    private readonly string _titleId = $"vibe-alert-dialog-title-{Guid.NewGuid():N}";
    private readonly string _descriptionId = $"vibe-alert-dialog-description-{Guid.NewGuid():N}";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (IsOpen && !_focusTrapActive)
        {
            _dialogModule ??= await JSRuntime.InvokeAsync<IJSObjectReference>(
                "import", "./_content/Vibe.UI/js/vibe-dialog.js");

            await _dialogModule.InvokeVoidAsync("activate", _dialogKey, _contentRef);
            _focusTrapActive = true;
        }
        else if (!IsOpen && _focusTrapActive)
        {
            if (_dialogModule != null)
            {
                await _dialogModule.InvokeVoidAsync("deactivate", _dialogKey);
            }

            _focusTrapActive = false;
        }
    }

    private async Task OnCloseClicked()
    {
        await CloseDialog();
    }

    private async Task OnBackdropClicked()
    {
        if (CloseOnBackdropClick)
        {
            await CloseDialog();
        }
    }

    private async Task CloseDialog()
    {
        if (IsOpenChanged.HasDelegate)
        {
            await IsOpenChanged.InvokeAsync(false);
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape" && CloseOnEscape)
        {
            await CloseDialog();
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_focusTrapActive && _dialogModule != null)
        {
            await _dialogModule.InvokeVoidAsync("deactivate", _dialogKey);
            _focusTrapActive = false;
        }

        if (_dialogModule != null)
        {
            await _dialogModule.DisposeAsync();
        }
    }
}