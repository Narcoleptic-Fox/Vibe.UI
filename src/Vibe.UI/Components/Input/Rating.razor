@namespace Vibe.UI.Components
@inherits ThemedComponentBase

<div @attributes="AdditionalAttributes" class="@CombinedCssClass" role="radiogroup" aria-label="@AriaLabel">
    @for (int i = 1; i <= MaxRating; i++)
    {
        var index = i;
        var isFilled = AllowHalf ? index <= Value : (int)Math.Ceiling(Value) >= index;
        var isHalfFilled = AllowHalf && Value >= index - 0.5 && Value < index;

        <button type="button"
                class="rating-star @(isFilled ? "star-filled" : "") @(isHalfFilled ? "star-half" : "")"
                @onclick="() => HandleClick(index)"
                @onmouseenter="() => HandleHover(index)"
                @onmouseleave="HandleHoverEnd"
                disabled="@(Disabled || ReadOnly)"
                aria-label="@($"{index} star{(index > 1 ? "s" : "")}")">
            @if (CustomIcon != null)
            {
                @CustomIcon
            }
            else
            {
                <span class="star-icon">@(isFilled || isHalfFilled ? "★" : "☆")</span>
            }
        </button>
    }

    @if (ShowValue)
    {
        <span class="rating-value">@Value.ToString("0.#") / @MaxRating</span>
    }
</div>

@code {
    private double _hoverValue;

    [Parameter]
    public double Value { get; set; }

    [Parameter]
    public EventCallback<double> ValueChanged { get; set; }

    [Parameter]
    public int MaxRating { get; set; } = 5;

    [Parameter]
    public bool AllowHalf { get; set; } = false;

    [Parameter]
    public bool ReadOnly { get; set; }

    [Parameter]
    public bool Disabled { get; set; }

    [Parameter]
    public bool ShowValue { get; set; }

    [Parameter]
    public RatingSize Size { get; set; } = RatingSize.Default;

    [Parameter]
    public RenderFragment? CustomIcon { get; set; }

    [Parameter]
    public string? AriaLabel { get; set; } = "Rating";

    [Parameter]
    public string? CssClass { get; set; }

    private string CombinedCssClass => CombineClasses(
        "vibe-rating",
        $"rating-{Size.ToString().ToLower()}",
        ReadOnly ? "rating-readonly" : null,
        Disabled ? "rating-disabled" : null,
        CssClass
    );

    protected override string ComponentClass => CombinedCssClass;

    private async Task HandleClick(int rating)
    {
        if (ReadOnly || Disabled) return;

        var newValue = AllowHalf && Value == rating ? rating - 0.5 : rating;
        Value = newValue;
        await ValueChanged.InvokeAsync(newValue);
    }

    private void HandleHover(int rating)
    {
        if (!ReadOnly && !Disabled)
        {
            _hoverValue = rating;
            StateHasChanged();
        }
    }

    private void HandleHoverEnd()
    {
        _hoverValue = 0;
        StateHasChanged();
    }

    public enum RatingSize
    {
        Small,
        Default,
        Large
    }
}
